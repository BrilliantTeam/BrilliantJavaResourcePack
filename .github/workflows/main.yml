name: 壓縮 zip、計算 SHA-1 並發佈到 Tag
on:
  push:
    branches:
      - main
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: 簽出儲存庫
        uses: actions/checkout@v4

      - name: 設置版本變量
        id: set_var
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch name is: $BRANCH_NAME"
          
          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "ZIP_LIGHT=bsje.zip" >> "$GITHUB_OUTPUT"
            echo "ZIP_DARK=bsje-dark.zip" >> "$GITHUB_OUTPUT"
            echo "ASSET_LIGHT=bsje.zip" >> "$GITHUB_OUTPUT"
            echo "ASSET_DARK=bsje-dark.zip" >> "$GITHUB_OUTPUT"
          else
            echo "ZIP_LIGHT=bsje-unknown.zip" >> "$GITHUB_OUTPUT"
            echo "ZIP_DARK=bsje-unknown-dark.zip" >> "$GITHUB_OUTPUT"
            echo "ASSET_LIGHT=bsje-unknown.zip" >> "$GITHUB_OUTPUT"
            echo "ASSET_DARK=bsje-unknown-dark.zip" >> "$GITHUB_OUTPUT"
          fi

      - name: 壓縮 Light 版 ZIP
        run: |
          echo "Creating Light ZIP: ${{ steps.set_var.outputs.ZIP_LIGHT }}"
          zip -r "${{ steps.set_var.outputs.ZIP_LIGHT }}" \
            assets/ 1.21.4/ 1.21.6/ LICENSE.txt pack.mcmeta pack.png \
            -x "darkmode/**" || exit 1
          echo "Light ZIP created:"
          ls -la "${{ steps.set_var.outputs.ZIP_LIGHT }}"

      - name: 壓縮 Dark 版 ZIP（合併 darkmode 資料夾）
        run: |
          echo "Creating Dark ZIP: ${{ steps.set_var.outputs.ZIP_DARK }}"
          
          zip -r "${{ steps.set_var.outputs.ZIP_DARK }}" \
            assets/ 1.21.4/ 1.21.6/ LICENSE.txt pack.mcmeta pack.png \
            -x "darkmode/**" || exit 1
          
          if [ -d "darkmode/assets" ]; then
            echo "Merging darkmode/assets into ZIP (overwriting conflicts)..."
            cd darkmode && zip -r "../${{ steps.set_var.outputs.ZIP_DARK }}" assets/ && cd ..
          fi
          
          echo "Dark ZIP created:"
          ls -la "${{ steps.set_var.outputs.ZIP_DARK }}"

      - name: 計算 SHA1
        id: hash
        run: |
          LIGHT_SHA1=$(sha1sum "${{ steps.set_var.outputs.ZIP_LIGHT }}" | cut -d' ' -f1)
          DARK_SHA1=$(sha1sum "${{ steps.set_var.outputs.ZIP_DARK }}" | cut -d' ' -f1)
          
          echo "RESOURCE_SHA1_LIGHT=$LIGHT_SHA1" >> "$GITHUB_OUTPUT"
          echo "RESOURCE_SHA1_DARK=$DARK_SHA1" >> "$GITHUB_OUTPUT"
          
          echo "Light SHA1: $LIGHT_SHA1"
          echo "Dark SHA1:  $DARK_SHA1"

      - name: 發佈並上傳 Release 
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.run_number }}
          name: Version ${{ github.run_number }} | ${{ github.event.head_commit.message }}
          body: |
            ### 亮色模式
            - **檔案**：`${{ steps.set_var.outputs.ASSET_LIGHT }}`
            - **SHA1**：`${{ steps.hash.outputs.RESOURCE_SHA1_LIGHT }}`

            ### 暗色模式
            - **檔案**：`${{ steps.set_var.outputs.ASSET_DARK }}`
            - **SHA1**：`${{ steps.hash.outputs.RESOURCE_SHA1_DARK }}`

            ---
            玩家可於 **Assets** 區塊中選擇下載：
            - 亮色模式材質包：`${{ steps.set_var.outputs.ASSET_LIGHT }}`
            - 暗色模式材質包：`${{ steps.set_var.outputs.ASSET_DARK }}`

            建議下載標有 **Latest** 的版本以獲得最佳體驗。

            Copyright © 輝煌伺服器 Brilliant Minecraft Server 版權所有 All rights reserved
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          files: |
            ${{ steps.set_var.outputs.ZIP_LIGHT }}
            ${{ steps.set_var.outputs.ZIP_DARK }}