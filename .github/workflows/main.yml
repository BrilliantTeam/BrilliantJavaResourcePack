name: 壓縮 zip、計算 SHA-1 並發佈到 Tag
on:
  push:
    branches:
    - main
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: 簽出儲存庫
      uses: actions/checkout@v2

    - name: 設置版本變量
      id: set_var
      run: |
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        echo "Branch name is: $BRANCH_NAME"
        
        if [[ "$BRANCH_NAME" == "main" ]]; then
          echo "ZIP_LIGHT=bsje.zip" >> $GITHUB_OUTPUT
          echo "ZIP_DARK=bsje-dark.zip" >> $GITHUB_OUTPUT
          echo "ASSET_LIGHT=bsje.zip" >> $GITHUB_OUTPUT
          echo "ASSET_DARK=bsje-dark.zip" >> $GITHUB_OUTPUT
        else
          echo "ZIP_LIGHT=bsje-unknown.zip" >> $GITHUB_OUTPUT
          echo "ZIP_DARK=bsje-unknown-dark.zip" >> $GITHUB_OUTPUT
          echo "ASSET_LIGHT=bsje-unknown.zip" >> $GITHUB_OUTPUT
          echo "ASSET_DARK=bsje-unknown-dark.zip" >> $GITHUB_OUTPUT
        fi

    - name: 壓縮 Light 版 ZIP
      run: |
        echo "Creating Light ZIP: ${{ steps.set_var.outputs.ZIP_LIGHT }}"
        zip -r "${{ steps.set_var.outputs.ZIP_LIGHT }}" \
          assets/* 1.21.4/* 1.21.6/* LICENSE.txt pack.mcmeta pack.png \
          -x "darkmode/**"
        ls -la "${{ steps.set_var.outputs.ZIP_LIGHT }}"

    - name: 壓縮 Dark 版 ZIP（合併 darkmode）
      run: |
        echo "Creating Dark ZIP: ${{ steps.set_var.outputs.ZIP_DARK }}"
        
        zip -r "${{ steps.set_var.outputs.ZIP_DARK }}" \
          assets/* 1.21.4/* 1.21.6/* LICENSE.txt pack.mcmeta pack.png \
          -x "darkmode/**"
        
        if [ -d "darkmode/assets" ]; then
          echo "Merging darkmode/assets (will overwrite conflicts)..."
          cd darkmode && zip -r "../${{ steps.set_var.outputs.ZIP_DARK }}" assets/* && cd ..
        fi
        
        ls -la "${{ steps.set_var.outputs.ZIP_DARK }}"

    - name: 計算 SHA1
      id: calculate_sha1
      run: |
        echo "RESOURCE_SHA1_LIGHT=$(sha1sum ${{ steps.set_var.outputs.ZIP_LIGHT }} | awk '{print $1}')" >> $GITHUB_OUTPUT
        echo "RESOURCE_SHA1_DARK=$(sha1sum ${{ steps.set_var.outputs.ZIP_DARK }} | awk '{print $1}')" >> $GITHUB_OUTPUT

    - name: 創建發佈
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.run_number }}
        release_name: Version ${{ github.run_number }} | ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false
        body: |
          ### 亮色模式
          - **檔案**：`${{ steps.set_var.outputs.ASSET_LIGHT }}`
          - **SHA1**：`${{ steps.calculate_sha1.outputs.RESOURCE_SHA1_LIGHT }}`

          ### 暗色模式
          - **檔案**：`${{ steps.set_var.outputs.ASSET_DARK }}`
          - **SHA1**：`${{ steps.calculate_sha1.outputs.RESOURCE_SHA1_DARK }}`

          ---
          玩家可於 **Assets** 區塊中選擇下載：
          - 亮色模式材質包：`${{ steps.set_var.outputs.ASSET_LIGHT }}`
          - 暗色模式材質包：`${{ steps.set_var.outputs.ASSET_DARK }}`

          建議下載標有 **Latest** 的版本以獲得最佳體驗。

          Copyright © 輝煌伺服器 Brilliant Minecraft Server 版權所有 All rights reserved

    - name: 上傳 Light 版 ZIP
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ steps.set_var.outputs.ZIP_LIGHT }}
        asset_name: ${{ steps.set_var.outputs.ASSET_LIGHT }}
        asset_content_type: application/zip

    - name: 上傳 Dark 版 ZIP
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ steps.set_var.outputs.ZIP_DARK }}
        asset_name: ${{ steps.set_var.outputs.ASSET_DARK }}
        asset_content_type: application/zip